<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashcat - M√®o Th·ªß Qu·ªπ</title>
    <!-- T·∫£i Tailwind CSS ƒë·ªÉ ƒë·∫£m b·∫£o phong c√°ch hi·ªán ƒë·∫°i v√† d·ªÖ d√†ng t√πy ch·ªânh -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Thi·∫øt l·∫≠p font Inter cho to√†n b·ªô ·ª©ng d·ª•ng */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* M√†u n·ªÅn nh·∫π nh√†ng */
        }
        /* M√†u ch·ªß ƒë·∫°o: N·ªÅn Cashcat Light (#FEEBCB) v√† Text/Accent Cashcat Dark (#795548) */
        .cashcat-light {
            background-color: #FEEBCB; 
        }
        .cashcat-dark {
            color: #795548; /* M√†u n√¢u ƒë·∫•t cho ch·ªØ */
        }
        .btn-primary {
            background-color: #795548;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #5D4037; /* M√†u ƒë·∫≠m h∆°n khi hover */
        }
        /* Ti√™u ƒë·ªÅ in hoa v√† t√¥ ƒë·∫≠m */
        .title-text {
            font-weight: 900;
            text-transform: uppercase;
        }
        /* Khu v·ª±c chat ·∫©n thanh cu·ªôn */
        .chat-area {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .chat-area::-webkit-scrollbar {
            display: none;
        }
        /* Giao di·ªán tin nh·∫Øn c·ªßa Cashcat */
        .cashcat-bubble {
            background-color: #FEEBCB;
            border: 1px solid #79554830;
        }
        /* Tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng */
        .user-bubble {
            background-color: #795548;
        }
        /* Style cho Emoji/Text Icon */
        .cashcat-icon {
            font-size: 3rem; /* L√†m emoji to l√™n */
            line-height: 1; /* CƒÉn gi·ªØa d·ªçc */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- KHUNG CHATBOX CH√çNH -->
    <div id="cashcatChat" class="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden flex flex-col h-[80vh] min-h-[500px]">

        <!-- HEADER -->
        <header class="cashcat-light p-4 shadow-md flex items-center justify-center space-x-3 border-b-4 border-[#795548]">
            
            <!-- THAY TH·∫æ IMAGE B·∫∞NG EMOJI V√Ä TEXT V√å L√ù DO B·∫¢O M·∫¨T (GUARANTEED TO RENDER) -->
            <div class="flex items-center justify-center w-12 h-12">
                <span class="cashcat-icon">üê±</span>
            </div>
            
            <!-- ƒê√É LO·∫†I B·ªé BI·ªÇU T∆Ø·ª¢NG TI·ªÄN THEO Y√äU C·∫¶U -->
            <h1 class="text-2xl title-text cashcat-dark text-center">
                CASHCAT
            </h1>
        </header>

        <!-- KHU V·ª∞C CHAT -->
        <main id="chatArea" class="chat-area flex-grow p-4 space-y-4 overflow-y-auto bg-white">
            <!-- N·ªôi dung chat s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
        </main>

        <!-- FOOTER / KHU V·ª∞C NH·∫¨P LI·ªÜU (T√πy theo tr·∫°ng th√°i) -->
        <footer id="inputArea" class="p-4 border-t border-gray-100 bg-gray-50">
            <!-- N√∫t b·∫•m/Input s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
        </footer>

        <!-- Modal hi·ªÉn th·ªã k·∫øt qu·∫£ (thay th·∫ø alert) -->
        <div id="resultModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 shadow-xl w-11/12 max-w-md">
                <h3 id="modalTitle" class="text-2xl font-bold mb-4 text-center cashcat-dark">K·∫æT LU·∫¨N C·ª¶A CASHCAT</h3>
                <p id="modalMessage" class="text-gray-700 text-center mb-6"></p>
                <div class="flex justify-center">
                    <button id="modalCloseBtn" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg">
                        Ho√†n t·∫•t
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- C·∫§U H√åNH V√Ä BI·∫æN TO√ÄN C·ª§C ---
        let appState = 'intro';
        let userSelection = {};
        let quizScore = 0;
        let quizMode = ''; 
        let currentQuizIndex = 0;
        let chatHistory = []; // L·ªãch s·ª≠ tin nh·∫Øn ƒë·ªÉ ki·ªÉm so√°t vi·ªác redraw

        // URL API Google Apps Script c·ªßa b·∫°n
        // L∆ØU √ù: Thay th·∫ø URL n√†y b·∫±ng URL Apps Script ƒë√£ tri·ªÉn khai c·ªßa b·∫°n
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwQhkZZdCH18Nd47dhqde8SJZ8NdoZe0wOT5PPIvZMVeK5BJMn3XFLH0Og8NkK8huO8/exec'; 

        // --- D·ªÆ LI·ªÜU C√ÇU H·ªéI V√Ä ƒêI·ªÇM S·ªê ---

        // Mapping ƒëi·ªÉm cho t·ª´ng lo·∫°i chi ti√™u (Buying Quiz)
        const QUIZ_BUYING_DATA = [
            // Q1. Importance
            { q: "M√≥n ƒë·ªì n√†y ph·ª•c v·ª• m·ª•c ƒë√≠ch g√¨?", opts: [
                { text: "Nhu c·∫ßu sinh t·ªìn / thi·∫øt y·∫øu", scores: { tight: 3, save: 3, comfort: 3 } },
                { text: "H·ªçc t·∫≠p / c√¥ng vi·ªác (thi·∫øt y·∫øu)", scores: { tight: 2, save: 2, comfort: 2 } },
                { text: "Ti·ªán nghi / gi·∫£i tr√≠", scores: { tight: 0, save: -1, comfort: -1 } },
                { text: "S·ªü th√≠ch / xu h∆∞·ªõng / c·∫£m t√≠nh", scores: { tight: -2, save: -2, comfort: -2 } }
            ]},
            // Q2. Urgency
            { q: "B·∫°n c√≥ c·∫ßn n√≥ ngay b√¢y gi·ªù kh√¥ng?", opts: [
                { text: "C·∫ßn ngay, ·∫£nh h∆∞·ªüng vi·ªác h·ªçc/s·ª©c kh·ªèe", scores: { tight: 3, save: 2, comfort: 3 } },
                { text: "C√≥ th·ªÉ ch·ªù v√†i ng√†y", scores: { tight: 1, save: 1, comfort: 1 } },
                { text: "Kh√¥ng g·∫•p", scores: { tight: 0, save: 0, comfort: 0 } },
                { text: "Mua v√¨ sale / FOMO / s·ª£ h·∫øt h√†ng", scores: { tight: -3, save: -3, comfort: -2 } }
            ]},
            // Q3. Affordability
            { q: "Sau khi mua, s·ªë ti·ªÅn c√≤n l·∫°i c√≥ ƒë·ªß cho nhu c·∫ßu c∆° b·∫£n tu·∫ßn/th√°ng kh√¥ng?", opts: [
                { text: "D∆∞ r√µ r·ªát (v·∫´n an to√†n)", scores: { tight: 2, save: 3, comfort: 3 } },
                { text: "D∆∞ ƒë·ªß tho·∫£i m√°i", scores: { tight: null, save: null, comfort: 2 } }, // Ch·ªâ c√≥ trong Comfort
                { text: "V·ª´a ƒë·ªß (nh∆∞ng kh√¥ng ·∫£nh h∆∞·ªüng c∆° b·∫£n)", scores: { tight: 0, save: 0, comfort: 1 } },
                { text: "R·∫•t ch·∫≠t v·∫≠t", scores: { tight: -2, save: -2, comfort: -2 } },
                { text: "Kh√¥ng ƒë·ªß", scores: { tight: -3, save: -3, comfort: -3 } }
            ]},
            // Q4. Opportunity Cost
            { q: "N·∫øu b·∫°n mua m√≥n n√†y, b·∫°n s·∫Ω ph·∫£i b·ªè qua ƒëi·ªÅu g√¨?", opts: [
                { text: "Kh√¥ng b·ªè qua g√¨ quan tr·ªçng", scores: { tight: 2, save: 2, comfort: 3 } },
                { text: "M·ªôt kho·∫£n chi nh·ªè kh√°c", scores: { tight: 0, save: 0, comfort: 1 } },
                { text: "Ti·ªÅn ti·∫øt ki·ªám ho·∫∑c m·ª•c ti√™u l·ªõn", scores: { tight: -3, save: -3, comfort: -3 } }
            ]},
            // Q5. Emotional Trigger
            { q: "Quy·∫øt ƒë·ªãnh mua c·ªßa b·∫°n xu·∫•t ph√°t t·ª´ ƒëi·ªÅu g√¨?", opts: [
                { text: "Nhu c·∫ßu th·ª±c s·ª±", scores: { tight: 3, save: 2, comfort: 3 } },
                { text: "M·ªôt ph·∫ßn c·∫£m x√∫c", scores: { tight: -1, save: -1, comfort: 0 } },
                { text: "Ch·ªß y·∫øu c·∫£m x√∫c (bu·ªìn, ch√°n, stress, FOMO, peer pressure)", scores: { tight: -3, save: -3, comfort: -3 } }
            ]},
            // Q6. Frequency
            { q: "Trong th√°ng, b·∫°n ƒë√£ mua th·ª© t∆∞∆°ng t·ª± bao nhi√™u l·∫ßn?", opts: [
                { text: "0 l·∫ßn", scores: { tight: 2, save: 2, comfort: 3 } },
                { text: "1‚Äì2 l·∫ßn", scores: { tight: 0, save: 0, comfort: 2 } },
                { text: "3‚Äì4 l·∫ßn", scores: { tight: -2, save: -1, comfort: -1 } },
                { text: "4 l·∫ßn (ho·∫∑c nhi·ªÅu h∆°n 4 l·∫ßn)", scores: { tight: -3, save: -2, comfort: -3 } }
            ]},
            // Q7. Longevity & Usefulness
            { q: "B·∫°n s·∫Ω d√πng m√≥n ƒë·ªì n√†y trong bao l√¢u?", opts: [
                { text: "Tr√™n 6 th√°ng", scores: { tight: 3, save: 2, comfort: 3 } },
                { text: "V√†i tu·∫ßn ƒë·∫øn v√†i th√°ng", scores: { tight: 1, save: 1, comfort: 1 } },
                { text: "1‚Äì2 l·∫ßn ho·∫∑c v√†i ng√†y", scores: { tight: -3, save: -3, comfort: -3 } }
            ]},
            // Q8. Alternatives
            { q: "C√≥ l·ª±a ch·ªçn r·∫ª h∆°n ho·∫∑c mi·ªÖn ph√≠ kh√¥ng?", opts: [
                { text: "Kh√¥ng c√≥", scores: { tight: 2, save: 2, comfort: 3 } },
                { text: "C√≥ nh∆∞ng kh√¥ng ti·ªán", scores: { tight: 0, save: 0, comfort: 1 } },
                { text: "C√≥ l·ª±a ch·ªçn t∆∞∆°ng ƒë∆∞∆°ng r·∫ª h∆°n", scores: { tight: -1, save: -1, comfort: -1 } },
                { text: "C√≥ b·∫£n mi·ªÖn ph√≠ / m∆∞·ª£n ƒë∆∞·ª£c", scores: { tight: -3, save: -3, comfort: -3 } },
                { text: "Ch∆∞a t√¨m hi·ªÉu", scores: { tight: -2, save: -1, comfort: -1 } }
            ]},
            // Q9. Regret Prediction
            { q: "Tr·∫£i nghi·ªám tr∆∞·ªõc ƒë√¢y v·ªõi m√≥n t∆∞∆°ng t·ª±?", opts: [
                { text: "H√†i l√≤ng", scores: { tight: 2, save: 2, comfort: 3 } },
                { text: "B√¨nh th∆∞·ªùng", scores: { tight: 0, save: 0, comfort: 1 } },
                { text: "H·ªëi h·∫≠n / l√£ng ph√≠", scores: { tight: -3, save: -3, comfort: -3 } }
            ]},
            // Q10. Long-term Goal Alignment
            { q: "M√≥n ƒë·ªì n√†y ·∫£nh h∆∞·ªüng th·∫ø n√†o t·ªõi m·ª•c ti√™u t√†i ch√≠nh c·ªßa b·∫°n?", opts: [
                { text: "H·ªó tr·ª£ tr·ª±c ti·∫øp m·ª•c ti√™u", scores: { tight: 3, save: 3, comfort: 3 } },
                { text: "Kh√¥ng ·∫£nh h∆∞·ªüng", scores: { tight: 0, save: 0, comfort: 1 } },
                { text: "·∫¢nh h∆∞·ªüng x·∫•u / k√©o b·∫°n xa m·ª•c ti√™u", scores: { tight: -3, save: -3, comfort: -3 } }
            ]}
        ];

        // Scoring for Event Quiz (Universal Score, only threshold changes based on quizMode)
        const QUIZ_EVENT_DATA = [
            // Q1. Connection
            { q: "Tham gia ho·∫°t ƒë·ªông n√†y gi√∫p b·∫°n k·∫øt n·ªëi t·ªët h∆°n v·ªõi ai?", opts: [
                { text: "Th·∫ßy c√¥, anh ch·ªã ƒëi tr∆∞·ªõc (ng∆∞·ªùi gi√∫p ƒë·ª° b·∫°n trong h·ªçc t·∫≠p)", score: 3 },
                { text: "B·∫°n b√® x√£ giao, quan h·ªá b√¨nh th∆∞·ªùng", score: 1 },
                { text: "Kh√¥ng k·∫øt n·ªëi th√™m ai ƒë·∫∑c bi·ªát", score: -1 }
            ]},
            // Q2. Relationship Building
            { q: "Ho·∫°t ƒë·ªông n√†y c√≥ gi√∫p b·∫°n x√¢y d·ª±ng m·ªëi quan h·ªá b·∫°n mu·ªën kh√¥ng?", opts: [
                { text: "C√≥, c·∫ßn thi·∫øt cho h·ªçc t·∫≠p.", score: 3 },
                { text: "C√≥, c·∫ßn thi·∫øt cho vi·ªác k·∫øt b·∫°n vui ch∆°i.", score: 2 },
                { text: "Kh√¥ng h·∫≥n, ch·ªâ l√† duy tr√¨ m·ªëi quan h·ªá s·∫µn c√≥.", score: 1 },
                { text: "Kh√¥ng ch·∫Øc, ch∆∞a x√°c ƒë·ªãnh ƒë·ªëi t∆∞·ª£ng c·ª• th·ªÉ.", score: 0 }
            ]},
            // Q3. FOMO
            { q: "N·∫øu b·∫°n kh√¥ng ƒëi, b·∫°n c√≥ c·∫£m gi√°c ti·∫øc th·∫≠t s·ª± kh√¥ng, hay ch·ªâ s·ª£ m·ªçi ng∆∞·ªùi ƒëi m√† b·∫°n kh√¥ng ƒëi?", opts: [
                { text: "R·∫•t ti·∫øc, c∆° h·ªôi duy nh·∫•t/ l·ªõn gi√∫p √≠ch vi·ªác h·ªçc.", score: 3 },
                { text: "Ch·ªâ b·ªã FOMO, s·ª£ b·ªè l·ª° c√°i g√¨ ƒë√≥ hay ho c√≥ th·ªÉ x·∫£y ra.", score: -2 },
                { text: "Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c.", score: 0 }
            ]},
            // Q4. Motivation
            { q: "B·∫°n c√≥ mu·ªën tham gia ngay c·∫£ khi kh√¥ng ai r·ªß?", opts: [
                { text: "C√≥, v√¨ mang l·∫°i l·ª£i √≠ch cho b·∫£n th√¢n.", score: 2 },
                { text: "Ch·∫Øc l√† kh√¥ng ƒëi, ƒëi m·ªôt m√¨nh bu·ªìn ch√°n l·∫Øm.", score: -2 },
                { text: "Ch∆∞a ch·∫Øc n·ªØa, ƒëi·ªÅu ki·ªán thu·∫≠n l·ª£i th√¨ c√≥ th·ªÉ ƒëi.", score: 0 }
            ]},
            // Q5. Affordability
            { q: "Sau khi tham gia, s·ªë ti·ªÅn c√≤n l·∫°i c·ªßa b·∫°n c√≥ ƒë·ªß s·ªëng s√≥t qua th·ªùi gian c√≤n l·∫°i kh√¥ng?", opts: [
                { text: "C√≥ th·ªÉ, c√≤n l·∫°i tr√™n 50% chi ph√≠ sinh ho·∫°t th√°ng.", score: 1 },
                { text: "Ch·∫Øc l√† kh√¥ng, c√≤n l·∫°i d∆∞·ªõi 20% chi ph√≠ sinh ho·∫°t th√°ng.", score: -3 },
                { text: "C≈©ng c√≥ th·ªÉ, c√≤n l·∫°i 20%-50% chi ph√≠ sinh ho·∫°t th√°ng.", score: 0 }
            ]},
            // Q6. Stress Relief/Value
            { q: "N√≥ c√≥ gi√∫p b·∫°n gi·∫£i t·ªèa stress hay mang l·∫°i gi√° tr·ªã tinh th·∫ßn kh√¥ng?", opts: [
                { text: "C√≥, n√≥ r·∫•t th√∫ v·ªã.", score: 2 },
                { text: "Kh√¥ng, t√¥i nghƒ© n√≥ s·∫Ω ch√°n.", score: -1 },
                { text: "Ch∆∞a tham gia n√™n c≈©ng ch∆∞a bi·∫øt n·ªØa.", score: 0 }
            ]},
            // Q7. Feel Better
            { q: "ƒêi c√≥ gi√∫p b·∫°n c·∫£m th·∫•y t·ªët h∆°n th·∫≠t kh√¥ng?", opts: [
                { text: "C√≥, s·ª± ki·ªán n√†y c√≥ m·ª•c ƒë√≠ch r√µ r√†ng.", score: 2 },
                { text: "Kh√¥ng ch·∫Øc l·∫Øm, ch∆∞a ch·∫Øc s·∫Ω hi·ªáu qu·∫£.", score: 0 }
            ]},
            // Q8. Study Impact
            { q: "ƒêi xong b·∫°n c√≥ b·ªã ·∫£nh h∆∞·ªüng h·ªçc t·∫≠p ho·∫∑c l·ªãch tr√¨nh kh√¥ng?", opts: [
                { text: "C√≥, b·ªã ·∫£nh h∆∞·ªüng (kh√¥ng k·ªãp l√†m b√†i t·∫≠p, tr√πng l·ªãch kh√°c)", score: -2 },
                { text: "Kh√¥ng, kh√¥ng b·ªã ·∫£nh h∆∞·ªüng", score: 1 }
            ]},
            // Q9. Long-term Memory
            { q: "Tham gia ho·∫°t ƒë·ªông n√†y c√≥ gi√∫p b·∫°n t·∫°o k·ª∑ ni·ªám hay m·ªëi quan h·ªá l√¢u d√†i kh√¥ng?", opts: [
                { text: "C√≥ th·ªÉ, t·∫°o ra k·ªâ ni·ªám ƒë·∫πp v·ªõi nh·ªØng m·ªëi quan h·ªá m·ªõi.", score: 2 },
                { text: "Kh√¥ng, ch·ªâ l√† tr·∫£i nghi·ªám vui v·∫ª t·∫°m th·ªùi.", score: -1 }
            ]},
            // Q10. Alternatives
            { q: "C√≥ c√°ch n√†o tham gia v·ªõi chi ph√≠ th·∫•p h∆°n kh√¥ng?", opts: [
                { text: "C√≥, c√≥ th·ªÉ ƒëi chung xe v·ªõi b·∫°n, kh√¥ng mua th√™m qu√† b√°nh n∆∞·ªõc,...", score: 2 },
                { text: "Kh√¥ng, chi ph√≠ ƒë√£ c·ªë ƒë·ªãnh.", score: -1 }
            ]}
        ];


        // --- H√ÄM H·ªñ TR·ª¢ HI·ªÇN TH·ªä ---
        
        // H√†m v·∫Ω l·∫°i to√†n b·ªô l·ªãch s·ª≠ chat
        function redrawChatArea() {
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = ''; // 1. X√≥a n·ªôi dung c≈© TR∆Ø·ªöC KHI V·∫º L·∫†I

            chatHistory.forEach(msg => {
                let contentClass = 'font-normal cashcat-bubble cashcat-dark'; 
                let contentStyle = 'font-normal';
                let finalContent = msg.content;
                let senderName = msg.sender === 'cashcat' ? 'Cashcat' : 'B·∫°n';
                let alignClass = msg.sender === 'cashcat' ? 'items-start' : 'items-end';
                let bubbleClass = msg.sender === 'cashcat' 
                    ? 'max-w-xs md:max-w-md p-3 rounded-xl rounded-tl-none shadow-md' 
                    : 'max-w-xs md:max-w-md user-bubble text-white p-3 rounded-xl rounded-tr-none shadow-md';
                
                // Logic cho tin nh·∫Øn Cashcat
                if (msg.sender === 'cashcat') {
                    // X·ª≠ l√Ω "meow"
                    if (msg.isMeow && msg.type !== 'intro_title' && msg.type !== 'intro_message') {
                         finalContent += " meow~";
                    }
                    
                    if (msg.type === 'question' || msg.type === 'quiz_q') {
                        contentStyle = 'font-bold';
                        contentClass = 'cashcat-bubble cashcat-dark';
                    } else if (msg.type === 'conclusion') {
                        contentClass = 'cashcat-bubble cashcat-dark font-bold'; // ƒê·∫£m b·∫£o l·ªùi c·∫£m ∆°n n·ªïi b·∫≠t
                    } else {
                        contentClass = 'cashcat-bubble cashcat-dark'; // Default Cashcat bubble
                    }
                }
                
                const messageHtml = `
                    <div class="flex flex-col ${alignClass}">
                        <div class="text-xs font-semibold mb-1 text-gray-500">${senderName}</div>
                        <div class="${bubbleClass} ${contentClass}">
                            <p class="text-sm leading-relaxed ${contentStyle}">${finalContent}</p>
                        </div>
                    </div>
                `;
                chatArea.insertAdjacentHTML('beforeend', messageHtml);
            });

            chatArea.scrollTop = chatArea.scrollHeight; // 2. Cu·ªôn xu·ªëng cu·ªëi
        }

        // H√†m th√™m tin nh·∫Øn v√†o l·ªãch s·ª≠ v√† v·∫Ω l·∫°i
        function pushMessage(sender, content, type = 'info', isMeow = true) {
            // Th√™m message v√†o l·ªãch s·ª≠
            chatHistory.push({ sender, content, type, isMeow });
            // V·∫Ω l·∫°i to√†n b·ªô khu v·ª±c chat
            redrawChatArea();
        }

        function renderOptions(options, handler) {
            const inputArea = document.getElementById('inputArea');
            inputArea.innerHTML = '';
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex flex-col space-y-2';
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option.text;
                button.className = 'w-full btn-primary text-white font-normal py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition ease-in-out duration-150';
                button.onclick = () => handler(option.value, option.text);
                buttonContainer.appendChild(button);
            });
            inputArea.appendChild(buttonContainer);
        }

        function renderEmailInput() {
            const inputArea = document.getElementById('inputArea');
            inputArea.innerHTML = `
                <div id="emailMessage" class="cashcat-dark mb-3 font-semibold text-center">H√£y nh·∫≠p email c·ªßa b·∫°n v√†o ƒë√¢y</div>
                <input type="email" id="emailInput" placeholder="Nh·∫≠p email c·ªßa b·∫°n..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#795548] mb-2">
                <button id="emailSubmitBtn" class="w-full btn-primary text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition ease-in-out duration-150">
                    G·ª≠i cho Cashcat
                </button>
            `;
            document.getElementById('emailSubmitBtn').onclick = submitEmail;
        }

        function showResultModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('resultModal').classList.remove('hidden');
            document.getElementById('resultModal').classList.add('flex');
            document.getElementById('modalCloseBtn').onclick = () => {
                document.getElementById('resultModal').classList.remove('flex');
                document.getElementById('resultModal').classList.add('hidden');
                // CHUY·ªÇN SANG H·ªéI XEM C√ì MU·ªêN B·∫ÆT ƒê·∫¶U L·∫†I KH√îNG
                appState = 'ask_restart';
                renderChatbox();
            };
        }

        function resetChat() {
            appState = 'intro';
            userSelection = {};
            quizScore = 0;
            quizMode = '';
            currentQuizIndex = 0;
            chatHistory = []; // X√≥a l·ªãch s·ª≠ chat
            document.getElementById('chatArea').innerHTML = ''; 
            renderChatbox();
        }


        // --- LOGIC X·ª¨ L√ù L∆ØU EMAIL (D√ôNG API GAS) ---
        // S·ª≠ d·ª•ng logic backoff ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªô ·ªïn ƒë·ªãnh khi g·ªçi API
        async function submitEmail() {
            const emailInput = document.getElementById('emailInput');
            const email = emailInput.value.trim();
            const submitBtn = document.getElementById('emailSubmitBtn');
            const messageElement = document.getElementById('emailMessage');
            
            if (!email || !email.includes('@')) {
                messageElement.textContent = "Vui l√≤ng nh·∫≠p m·ªôt email h·ª£p l·ªá!";
                messageElement.classList.add('text-red-500');
                return;
            }

            submitBtn.textContent = 'ƒêang g·ª≠i...';
            submitBtn.disabled = true;
            messageElement.classList.remove('text-red-500');
            messageElement.textContent = "ƒêang k·∫øt n·ªëi...";


            const payload = {
                email: email,
                style: userSelection.style || 'default', 
                timestamp: new Date().toISOString()
            };

            const maxRetries = 3;
            let currentRetry = 0;

            const makeApiCall = async () => {
                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors', 
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        messageElement.textContent = "Cashcat ƒë√£ l∆∞u l·∫°i email v√† phong c√°ch b·∫°n ch·ªçn! meow~";
                        appState = 'ask_restart';
                        renderChatbox();
                        return true; // Th√†nh c√¥ng
                    } else {
                        throw new Error('API returned failure status');
                    }
                } catch (error) {
                    console.error('L·ªói khi g·ªçi API:', error);
                    throw error; // N√©m l·ªói ƒë·ªÉ k√≠ch ho·∫°t retry
                }
            };

            while (currentRetry < maxRetries) {
                try {
                    const success = await makeApiCall();
                    if (success) return;
                } catch (error) {
                    currentRetry++;
                    if (currentRetry < maxRetries) {
                        const delay = Math.pow(2, currentRetry) * 1000; // Exponential backoff: 2s, 4s
                        messageElement.textContent = `Th·ª≠ l·∫°i l·∫ßn ${currentRetry} sau ${delay / 1000} gi√¢y...`;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            // N·∫øu th·∫•t b·∫°i sau t·∫•t c·∫£ c√°c l·∫ßn th·ª≠
            messageElement.textContent = "L·ªói khi l∆∞u tr·ªØ email. Vui l√≤ng ki·ªÉm tra API URL v√† tri·ªÉn khai GAS.";
            messageElement.classList.add('text-red-500');
            submitBtn.textContent = 'G·ª≠i cho Cashcat';
            submitBtn.disabled = false;
        }


        // --- LOGIC X·ª¨ L√ù TR·∫†NG TH√ÅI V√Ä ƒê√ÅP √ÅN ---

        function handleAnswer(value, text, score = 0) {
            // 1. Th√™m c√¢u tr·∫£ l·ªùi c·ªßa ng∆∞·ªùi d√πng v√†o giao di·ªán
            // ƒê√£ c·∫≠p nh·∫≠t ƒë·ªÉ d√πng pushMessage
            pushMessage('user', text, 'response', false); 

            // --- Logic Quiz (T√≠nh ƒëi·ªÉm) ---
            if (appState.startsWith('quiz')) {
                quizScore += score;
                currentQuizIndex++;
                let quizData = appState.includes('buying') ? QUIZ_BUYING_DATA : QUIZ_EVENT_DATA;

                if (currentQuizIndex < quizData.length) {
                    renderQuizQuestion(quizData[currentQuizIndex], appState.includes('buying') ? 'buying' : 'event');
                    return;
                } else {
                    appState = appState.replace('quiz_', 'result_');
                    renderChatbox();
                    return;
                }
            }

            // --- Chuy·ªÉn tr·∫°ng th√°i ---
            switch (appState) {
                case 'intro':
                    appState = (value === 'manage') ? 'branch1_q1' : 'branch2_q1';
                    break;
                case 'branch1_q1':
                    appState = (value === 'simple') ? 'branch1_1_info' : 'branch1_2_info';
                    break;
                case 'branch1_email_q1':
                    appState = (value === 'yes') ? 'branch1_email_q2' : 'ask_restart'; // N·∫øu "Kh√¥ng" -> h·ªèi restart
                    break;
                case 'branch1_email_q2':
                    userSelection.style = text; // L∆∞u l·∫°i phong c√°ch (Th√¢n thi·ªán/Nghi√™m kh·∫Øc)
                    appState = 'branch1_email_input';
                    break;
                case 'branch2_q1':
                    appState = (value === 'buying') ? 'branch2_1_q1' : 'branch2_2_q1';
                    break;
                case 'branch2_1_q1': // Ch·ªçn mode chi ti√™u cho Buying Quiz
                    quizMode = value; // 'tight', 'save', 'comfort'
                    appState = 'quiz_buying';
                    currentQuizIndex = 0;
                    break;
                case 'branch2_2_q1': // Ch·ªçn mode chi ti√™u cho Event Quiz
                    quizMode = value; // 'moderate', 'rich', 'strict'
                    appState = 'quiz_event';
                    currentQuizIndex = 0;
                    break;
                case 'ask_restart':
                    if (value === 'yes') {
                        resetChat();
                        return;
                    } else {
                        appState = 'conclusion'; // User tr·∫£ l·ªùi "Kh√¥ng" -> chuy·ªÉn sang tr·∫°ng th√°i c·∫£m ∆°n
                    }
                    break;
            }
            renderChatbox();
        }

        function renderQuizQuestion(quizData, quizType) {
            // ƒê√£ c·∫≠p nh·∫≠t ƒë·ªÉ d√πng pushMessage, ƒë·∫£m b·∫£o l·ªãch s·ª≠ ƒë∆∞·ª£c v·∫Ω l·∫°i ƒë√∫ng
            pushMessage('cashcat', `(C√¢u ${currentQuizIndex + 1}/10) ${quizData.q}`, 'quiz_q');

            const options = quizData.opts
                .map(option => {
                    let score = 0;
                    let optionText = option.text;

                    if (quizType === 'buying') {
                        // L·∫•y ƒëi·ªÉm t∆∞∆°ng ·ª©ng v·ªõi ch·∫ø ƒë·ªô chi ti√™u hi·ªán t·∫°i (quizMode: tight/save/comfort)
                        score = option.scores[quizMode];
                    } else if (quizType === 'event') {
                        // Event quiz d√πng ƒëi·ªÉm chung, quizMode ch·ªâ quy·∫øt ƒë·ªãnh threshold cu·ªëi
                        score = option.score;
                    }
                    
                    // B·ªè qua c√°c option kh√¥ng √°p d·ª•ng cho ch·∫ø ƒë·ªô hi·ªán t·∫°i (score == null)
                    if (score === null || score === undefined) return null;

                    // Tr·∫£ v·ªÅ text v√† gi√° tr·ªã, score ƒë∆∞·ª£c ·∫©n trong value ƒë·ªÉ handleAnswer() l·∫•y
                    // ƒêi·ªÉm s·ªë kh√¥ng hi·ªÉn th·ªã cho user
                    return {
                        text: optionText,
                        value: JSON.stringify({ text: optionText, score: score })
                    };
                })
                .filter(option => option !== null); // Lo·∫°i b·ªè options null (v√≠ d·ª•: Q3 c·ªßa Buying)

            // Handler ƒë·∫∑c bi·ªát cho Quiz ƒë·ªÉ truy·ªÅn ƒëi·ªÉm
            const quizHandler = (jsonValue, text) => {
                const data = JSON.parse(jsonValue);
                handleAnswer(text, data.text, data.score);
            };

            renderOptions(options, quizHandler);
        }

        // --- H√ÄM RENDER CH√çNH ---
        function renderChatbox() {
            const inputArea = document.getElementById('inputArea');
            inputArea.innerHTML = '';
            
            // C√°c case state:
            switch (appState) {
                case 'intro':
                    // ƒê√£ c·∫≠p nh·∫≠t ƒë·ªÉ d√πng pushMessage
                    pushMessage('cashcat', "M√®o Th·ªß Qu·ªπ t·ª´ng l√† ‚Äúk·∫ø to√°n tr∆∞·ªüng‚Äù c·ªßa V∆∞∆°ng Qu·ªëc M√®o, n·ªïi ti·∫øng v·ªõi kh·∫£ nƒÉng ph√°t hi·ªán th·∫•t tho√°t ng√¢n s√°ch ch·ªâ trong m·ªôt gi·ªù. Sau khi th·∫•y sinh vi√™n loay hoay v√¨ h·∫øt ti·ªÅn gi·ªØa th√°ng, n√≥ quy·∫øt ƒë·ªãnh ‚Äúngh·ªâ c√¥ng t√°c‚Äù ƒë·ªÉ tr·ªü th√†nh mentor t√†i ch√≠nh cho con ng∆∞·ªùi. N√≥ lu√¥n n√≥i: ‚ÄúTi·ªÅn kh√¥ng t·ª± sinh ra, nh∆∞ng t∆∞ duy ƒë√∫ng c√≥ th·ªÉ gi√∫p n√≥ l·ªõn l√™n meow~.‚Äù", 'intro_title', false);
                    setTimeout(() => {
                        pushMessage('cashcat', "Ch√†o b·∫°n, m√¨nh l√† Cashcat, m·ªôt ch√∫ m√®o th·ªß qu·ªπ ƒë∆∞·ª£c tri·ªáu h·ªìi ƒë·∫øn ƒë·ªÉ gi√∫p ƒë·ª° c√°c b·∫°n ƒëang g·∫∑p kh√≥ khƒÉn trong v·∫•n ƒë·ªÅ t√†i ch√≠nh.", 'intro_message', false);
                        setTimeout(() => {
                            pushMessage('cashcat', "B·∫°n mu·ªën m√¨nh gi√∫p ƒë·ª° ƒëi·ªÅu g√¨?", 'question', false);
                            renderOptions([
                                { text: "Cung c·∫•p prompt gi√∫p m√¨nh gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ v·ªÅ c√°ch qu·∫£n l√≠ ti·ªÅn b·∫°c c·ªßa m√¨nh.", value: 'manage' },
                                { text: "Gi√∫p m√¨nh ƒë∆∞a ra quy·∫øt ƒë·ªãnh chi ti√™u", value: 'decision' }
                            ], handleAnswer);
                        }, 500);
                    }, 500);
                    break;

                // --- BRANCH 1: QU·∫¢N L√ù TI·ªÄN B·∫†C ---
                case 'branch1_q1':
                    pushMessage('cashcat', "B·∫°n th∆∞·ªùng qu·∫£n l√Ω chi ti√™u theo c√°ch n√†o?", 'question', false);
                    renderOptions([
                        { text: "T√¥i ∆∞u ti√™n s·ª± ƒë∆°n gi·∫£n, th∆∞·ªùng ch·ªâ mu·ªën bi·∫øt t·ªïng s·ªë ti·ªÅn m√¨nh c√≥ th·ªÉ s·ª≠ d·ª•ng m√† kh√¥ng ph·∫£i ghi ch√©p nhi·ªÅu.", value: 'simple' },
                        { text: "T√¥i mu·ªën n·∫Øm r√µ chi ti√™u h√†ng th√°ng, th√≠ch theo d√µi chi ti·∫øt ƒë·ªÉ t·ªëi ∆∞u t·ª´ng kho·∫£n.", value: 'detail' }
                    ], handleAnswer);
                    break;

                case 'branch1_1_info': // Simple Methods
                    pushMessage('cashcat', `
                        Cashcat nghƒ© r·∫±ng b·∫°n ph√π h·ª£p v·ªõi hai ph∆∞∆°ng ph√°p qu·∫£n l√Ω chi ti√™u sau:
                        <br><br>
                        <strong class="text-lg cashcat-dark">üëâ Ph∆∞∆°ng ph√°p 80/20</strong>
                        <br>
                        80% cho to√†n b·ªô chi ti√™u thi·∫øt y·∫øu + chi ti√™u linh ho·∫°t
                        <br>
                        20% cho ti·∫øt ki·ªám ho·∫∑c tr·∫£ n·ª£
                        <br>
                        <em class="text-xs">ƒê√¢y l√† c√°ch qu·∫£n l√Ω t·ªëi gi·∫£n, d·ªÖ √°p d·ª•ng v√† ph√π h·ª£p v·ªõi ng∆∞·ªùi th√≠ch s·ª± ƒë∆°n gi·∫£n.</em>
                        <br><br>
                        <strong class="text-base cashcat-dark font-bold">üëâ Prompt b·∫°n c√≥ th·ªÉ d√πng v·ªõi Chat GPT/Gemini/DeepSeek:</strong>
                        <br>
                        T√¥i ƒëang c√≥ s·ªë ti·ªÅn: [S·ªê TI·ªÄN], s·ª≠ d·ª•ng trong [S·ªê TH√ÅNG] th√°ng.
                        <br>
                        H√£y gi√∫p t√¥i chia kho·∫£n ti·ªÅn n√†y theo quy t·∫Øc 80/20. H√£y cho t√¥i bi·∫øt s·ªë ti·ªÅn c·ª• th·ªÉ cho 80% (chi ti√™u) v√† 20% (ti·∫øt ki·ªám/tr·∫£ n·ª£), v√† ƒë∆∞a ra l·ªùi khuy√™n t·ªëi ∆∞u n·∫øu kho·∫£n ti·ªÅn t√¥i c√≥ ch∆∞a ph√π h·ª£p v·ªõi m√¥ h√¨nh n√†y.
                        <br><br>
                        <strong class="text-lg cashcat-dark">üëâ Ph∆∞∆°ng ph√°p 70/20/10</strong>
                        <br>
                        70% chi ti√™u h·∫±ng th√°ng
                        <br>
                        20% ti·∫øt ki·ªám/ƒë·∫ßu t∆∞
                        <br>
                        10% ph√°t tri·ªÉn b·∫£n th√¢n
                        <br>
                        <em class="text-xs">C√°ch l√†m n√†y v·ª´a ƒë∆°n gi·∫£n v·ª´a gi√∫p b·∫°n c√≥ s·ª± c√¢n b·∫±ng gi·ªØa chi ti√™u ‚Äì ti·∫øt ki·ªám ‚Äì ph√°t tri·ªÉn c√° nh√¢n.</em>
                        <br><br>
                        <strong class="text-base cashcat-dark font-bold">üëâ Prompt b·∫°n c√≥ th·ªÉ d√πng v·ªõi Chat GPT/Gemini/DeepSeek:</strong>
                        <br>
                        T√¥i ƒëang c√≥ s·ªë ti·ªÅn: [S·ªê TI·ªÄN], s·ª≠ d·ª•ng trong [S·ªê TH√ÅNG] th√°ng.
                        <br>
                        H√£y gi√∫p t√¥i chia kho·∫£n ti·ªÅn n√†y theo quy t·∫Øc 70/20/10 v·ªõi 70% chi ti√™u, 20% ti·∫øt ki·ªám/ƒë·∫ßu t∆∞, v√† 10% ph√°t tri·ªÉn b·∫£n th√¢n. H√£y t√≠nh s·ªë ti·ªÅn c·ª• th·ªÉ cho t·ª´ng m·ª•c v√† g·ª£i √Ω ƒëi·ªÅu ch·ªânh n·∫øu c·∫ßn.
                    `, 'info', false);
                    appState = 'branch1_email_q1';
                    setTimeout(renderChatbox, 500);
                    break;

                case 'branch1_2_info': // Detailed Methods
                    pushMessage('cashcat', `
                        Cashcat nghƒ© r·∫±ng b·∫°n ph√π h·ª£p v·ªõi c√°c ph∆∞∆°ng ph√°p qu·∫£n l√Ω chi ti√™u chi ti·∫øt sau:
                        <br><br>
                        <strong class="text-lg cashcat-dark">üëâ Ph∆∞∆°ng ph√°p 50/30/20 (N√¢ng Cao)</strong>
                        <br>
                        50% nhu c·∫ßu thi·∫øt y·∫øu (nh√† ·ªü, ƒÉn u·ªëng, ƒëi·ªán n∆∞·ªõc‚Ä¶)
                        <br>
                        30% mong mu·ªën (mua s·∫Øm, gi·∫£i tr√≠‚Ä¶)
                        <br>
                        20% ti·∫øt ki·ªám/ƒë·∫ßu t∆∞
                        <br>
                        <em class="text-xs">Phi√™n b·∫£n n√¢ng cao c√≤n chia nh·ªè t·ª´ng m·ª•c ƒë·ªÉ ki·ªÉm so√°t chi ti·∫øt h∆°n, r·∫•t h·ª£p v·ªõi ng∆∞·ªùi th√≠ch theo d√µi s√°t sao chi ti√™u.</em>
                        <br><br>
                        <strong class="text-base cashcat-dark font-bold">üëâ Prompt b·∫°n c√≥ th·ªÉ d√πng v·ªõi Chat GPT/Gemini/DeepSeek:</strong>
                        <br>
                        T√¥i ƒëang c√≥ s·ªë ti·ªÅn: [S·ªê TI·ªÄN], s·ª≠ d·ª•ng trong [S·ªê TH√ÅNG] th√°ng.
                        <br>
                        H√£y gi√∫p t√¥i chia kho·∫£n ti·ªÅn n√†y theo m√¥ h√¨nh 50/30/20 n√¢ng cao. Ngo√†i 3 nh√≥m ch√≠nh (thi·∫øt y·∫øu ‚Äì mong mu·ªën ‚Äì ti·∫øt ki·ªám), h√£y chia nh·ªè t·ª´ng nh√≥m th√†nh c√°c danh m·ª•c chi ti√™u c·ª• th·ªÉ v√† g·ª£i √Ω c√°ch theo d√µi ƒë·ªÉ t·ªëi ∆∞u chi ti√™u h·∫±ng th√°ng.
                        <br><br>
                        <strong class="text-lg cashcat-dark">üëâ Ph∆∞∆°ng ph√°p 6 Chi·∫øc L·ªç (JARS System)</strong>
                        <br>
                        M√¥ h√¨nh 6 h≈© chia thu nh·∫≠p th√†nh:
                        <ul class="list-disc pl-5">
                            <li>NEC ‚Äì Chi ti√™u thi·∫øt y·∫øu</li>
                            <li>FFA ‚Äì ƒê·∫ßu t∆∞, tƒÉng thu nh·∫≠p</li>
                            <li>LTSS ‚Äì M·ª•c ti√™u d√†i h·∫°n</li>
                            <li>EDU ‚Äì H·ªçc t·∫≠p, n√¢ng cao b·∫£n th√¢n</li>
                            <li>PLAY ‚Äì Gi·∫£i tr√≠</li>
                            <li>GIVE ‚Äì T·ª´ thi·ªán</li>
                        </ul>
                        <em class="text-xs">Ph∆∞∆°ng ph√°p n√†y c·ª±c chi ti·∫øt v√† gi√∫p ng∆∞·ªùi d√πng c√≥ s·ª± c√¢n b·∫±ng gi·ªØa chi ti√™u ‚Äì ti·∫øt ki·ªám ‚Äì ph√°t tri·ªÉn c√° nh√¢n.</em>
                        <br><br>
                        <strong class="text-base cashcat-dark font-bold">üëâ Prompt b·∫°n c√≥ th·ªÉ d√πng v·ªõi ChatGPT/Gemini/DeepSeek:</strong>
                        <br>
                        T√¥i ƒëang c√≥ s·ªë ti·ªÅn: [S·ªê TI·ªÄN], s·ª≠ d·ª•ng trong [S·ªê TH√ÅNG] th√°ng.
                        <br>
                        H√£y gi√∫p t√¥i ph√¢n b·ªï kho·∫£n ti·ªÅn n√†y theo ph∆∞∆°ng ph√°p 6 chi·∫øc l·ªç (NEC, FFA, LTSS, EDU, PLAY, GIVE). H√£y ghi r√µ s·ªë ti·ªÅn c·ª• th·ªÉ cho t·ª´ng l·ªç v√† gi·∫£i th√≠ch vai tr√≤ c·ªßa m·ªói l·ªç ƒë·ªÉ t√¥i d·ªÖ theo d√µi.
                        <br><br>
                        <strong class="text-lg cashcat-dark">üëâ Ph∆∞∆°ng ph√°p Zero-Based Budgeting (ZBB)</strong>
                        <br>
                        Zero-Based Budgeting y√™u c·∫ßu ph√¢n b·ªï t·ª´ng ƒë·ªìng ƒë·∫øn ƒë√∫ng m·ªôt m·ª•c ƒë√≠ch. R·∫•t ph√π h·ª£p cho ng∆∞·ªùi mu·ªën ki·ªÉm so√°t ch√≠nh x√°c v√† t·ªëi ∆∞u h√≥a chi ti√™u.
                        <br><br>
                        <strong class="text-base cashcat-dark font-bold">üëâ Prompt b·∫°n c√≥ th·ªÉ d√πng v·ªõi ChatGPT/Gemini/DeepSeek:</strong>
                        <br>
                        T√¥i ƒëang c√≥ s·ªë ti·ªÅn: [S·ªê TI·ªÄN], s·ª≠ d·ª•ng trong [S·ªê TH√ÅNG] th√°ng.
                        <br>
                        H√£y √°p d·ª•ng ph∆∞∆°ng ph√°p Zero-Based Budgeting ƒë·ªÉ ph√¢n b·ªï to√†n b·ªô kho·∫£n ti·ªÅn n√†y. H√£y chia nh·ªè t·ª´ng lo·∫°i chi ti√™u v√† ƒë·∫£m b·∫£o t·ªïng chi ti√™u b·∫±ng ƒë√∫ng s·ªë ti·ªÅn t√¥i c√≥. ƒê∆∞a ra ƒë·ªÅ xu·∫•t t·ªëi ∆∞u n·∫øu c√≥ danh m·ª•c v∆∞·ª£t m·ª©c c·∫ßn thi·∫øt.
                    `, 'info', false);
                    appState = 'branch1_email_q1';
                    setTimeout(renderChatbox, 500);
                    break;

                case 'branch1_email_q1':
                    pushMessage('cashcat', "B·∫°n c√≥ mu·ªën Cashcat nh·∫Øc b·∫°n m·ªói ng√†y v·ªÅ vi·ªác ghi ch√©p chi ti√™u kh√¥ng?", 'question', false);
                    renderOptions([
                        { text: "C√≥", value: 'yes' },
                        { text: "Kh√¥ng", value: 'no' }
                    ], handleAnswer);
                    break;

                case 'branch1_email_q2':
                    pushMessage('cashcat', "B·∫°n mu·ªën m√¨nh ƒë√≥ng vai tr√≤ n√†o?", 'question', false);
                    renderOptions([
                        { text: "Th√¢n thi·ªán, g·∫ßn g≈©i.", value: 'friendly' },
                        { text: "Nghi√™m kh·∫Øc.", value: 'strict' }
                    ], handleAnswer);
                    break;

                case 'branch1_email_input':
                    // C√¢u h·ªèi ƒë√£ ƒë∆∞·ª£c th√™m trong h√†m renderEmailInput
                    renderEmailInput();
                    break;

                // --- BRANCH 2: QUY·∫æT ƒê·ªäNH CHI TI√äU ---
                case 'branch2_q1':
                    pushMessage('cashcat', "B·∫°n ƒëang ph√¢n v√¢n trong v·∫•n ƒë·ªÅ g√¨?", 'question', false);
                    renderOptions([
                        { text: "M√¨nh ph√¢n v√¢n trong vi·ªác c√≥ n√™n mua g√¨ ƒë√≥ kh√¥ng.", value: 'buying' },
                        { text: "M√¨nh ph√¢n v√¢n trong vi·ªác c√≥ n√™n tham gia s·ª± ki·ªán ƒë√≥ kh√¥ng.", value: 'event' }
                    ], handleAnswer);
                    break;

                // Branch 2.1 - Buying Quiz Setup
                case 'branch2_1_q1':
                    pushMessage('cashcat', "Hi·ªán t·∫°i nhu c·∫ßu chi ti√™u c·ªßa b·∫°n l√† g√¨?", 'question', false);
                    renderOptions([
                        { text: "T√¥i c·∫ßn si·∫øt ch·∫∑t chi ti√™u.", value: 'tight' },
                        { text: "T√¥i mu·ªën ti·∫øt ki·ªám h∆°n.", value: 'save' },
                        { text: "T√¥i d∆∞ d·∫£ nh∆∞ng mu·ªën qu·∫£n l√Ω chi ti√™u h·ª£p l√Ω h∆°n.", value: 'comfort' }
                    ], handleAnswer);
                    break;

                // Branch 2.2 - Event Quiz Setup
                case 'branch2_2_q1':
                    pushMessage('cashcat', "T√¨nh tr·∫°ng kinh t·∫ø hi·ªán t·∫°i c·ªßa b·∫°n nh∆∞ th·∫ø n√†o?", 'question', false);
                    renderOptions([
                        { text: "M√¨nh kh√¥ng c·∫ßn qu√° ti·∫øt ki·ªám.", value: 'moderate' },
                        { text: "M√¨nh ƒëang s·ªëng d∆∞ d·∫£, kh√¥ng √°p l·ª±c ti·ªÅn b·∫°c.", value: 'rich' },
                        { text: "M√¨nh th·∫≠t s·ª± c·∫ßn ti·∫øt ki·ªám.", value: 'strict' }
                    ], handleAnswer);
                    break;

                // --- QUIZ EXECUTION ---
                case 'quiz_buying':
                    renderQuizQuestion(QUIZ_BUYING_DATA[currentQuizIndex], 'buying');
                    break;
                case 'quiz_event':
                    renderQuizQuestion(QUIZ_EVENT_DATA[currentQuizIndex], 'event');
                    break;

                // --- QUIZ RESULTS (ƒê√É ·∫®N ƒêI·ªÇM N·ªòI B·ªò) ---
                case 'result_buying':
                    let buyingResultText = "";
                    const scoreBuying = quizScore;
                    
                    if (quizMode === 'tight') { // T√¥i c·∫ßn si·∫øt ch·∫∑t chi ti√™u.
                        if (scoreBuying >= 10) {
                            buyingResultText = "<strong>N√äN MUA</strong><br>ƒê√¢y l√† m·ªôt kho·∫£n chi c·∫ßn thi·∫øt v√† h·ª£p l√Ω. B·∫°n c√≥ th·ªÉ mua n√≥.";
                        } else if (scoreBuying >= 1) { // 1 <= score <= 9
                            buyingResultText = "<strong>C√ÇN NH·∫ÆC TH√äM</strong><br>H√£y c√¢n nh·∫Øc th·∫≠t k·ªπ. T·ªët nh·∫•t b·∫°n n√™n ƒë·ª£i 24-48 gi·ªù tr∆∞·ªõc khi quy·∫øt ƒë·ªãnh.";
                        } else { // score <= 0
                            buyingResultText = "<strong>KH√îNG N√äN MUA</strong><br>Kh√¥ng n√™n mua l√∫c n√†y. M√≥n ƒë·ªì n√†y c√≥ th·ªÉ ·∫£nh h∆∞·ªüng ƒë·∫øn k·∫ø ho·∫°ch t√†i ch√≠nh c·ªßa b·∫°n.";
                        }
                    } else if (quizMode === 'save') { // T√¥i mu·ªën ti·∫øt ki·ªám h∆°n.
                        if (scoreBuying >= 10) {
                            buyingResultText = "<strong>N√äN MUA</strong><br>B·∫°n ƒë√£ c√¢n nh·∫Øc kh√° k·ªπ v√† m√≥n ƒë·ªì n√†y mang l·ª£i √≠ch r√µ r√†ng, v·∫≠y th√¨ ch·ªù g√¨ n·ªØa n√≠! B·∫°n ho√†n to√†n c√≥ th·ªÉ mua n√®!";
                        } else if (scoreBuying >= 5) { // 5 <= score <= 9
                            buyingResultText = "<strong>C√ÇN NH·∫ÆC TH√äM</strong><br>H√£y c√¢n nh·∫Øc th·∫≠t k·ªπ tr∆∞·ªõc khi mua m√≥n ƒë·ªì n√†y, b·∫°n c√≥ th·ªÉ ƒë·ª£i th√™m m·ªôt th·ªùi gian r·ªìi h·∫µng quy·∫øt ƒë·ªãnh nh√©!";
                        } else { // score < 5
                            buyingResultText = "<strong>KH√îNG N√äN MUA</strong><br>D·ª±a tr√™n c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n, m√≥n n√†y ch∆∞a th·ª±c s·ª± c·∫ßn thi·∫øt v√† c√≥ th·ªÉ khi·∫øn b·∫°n m·∫•t ki·ªÉm so√°t chi ti√™u. B·∫°n kh√¥ng n√™n mua l√∫c n√†y,... h·∫øt c·ª©u ƒë√≥!";
                        }
                    } else if (quizMode === 'comfort') { // T√¥i d∆∞ d·∫£ nh∆∞ng mu·ªën qu·∫£n l√Ω chi ti√™u h·ª£p l√Ω h∆°n.
                        if (scoreBuying >= 12) {
                            buyingResultText = "<strong>N√äN MUA</strong><br>B·∫°n ho√†n to√†n c√≥ th·ªÉ mua. Quy·∫øt ƒë·ªãnh n√†y h·ª£p l√Ω v·ªõi m·ª•c ti√™u qu·∫£n l√Ω chi ti√™u c·ªßa b·∫°n.";
                        } else if (scoreBuying >= 4) { // 4 <= score <= 11
                            buyingResultText = "<strong>C√ÇN NH·∫ÆC TH√äM</strong><br>C√≥ th·ªÉ mua, nh∆∞ng b·∫°n n√™n c√¢n nh·∫Øc ho·∫∑c ƒë·ª£i 24 gi·ªù ƒë·ªÉ xem c√≥ c√≤n mu·ªën n·ªØa kh√¥ng.";
                        } else { // score <= 3
                            buyingResultText = "<strong>KH√îNG N√äN MUA</strong><br>Kh√¥ng n√™n mua. M√≥n n√†y kh√¥ng mang l·∫°i l·ª£i √≠ch t∆∞∆°ng x·ª©ng v√† d·ªÖ d·∫´n ƒë·∫øn chi ti√™u kh√¥ng hi·ªáu qu·∫£.";
                        }
                    }
                    showResultModal("K·∫æT LU·∫¨N C·ª¶A CASHCAT", buyingResultText);
                    break;

                case 'result_event':
                    let eventResultText = "";
                    const scoreEvent = quizScore;
                    
                    if (quizMode === 'moderate') { // M√¨nh kh√¥ng c·∫ßn qu√° ti·∫øt ki·ªám (Threshold: 8)
                        if (scoreEvent >= 8) {
                            eventResultText = "<strong>N√äN THAM GIA</strong><br>ƒê√¢y l√† ho·∫°t ƒë·ªông mang l·∫°i gi√° tr·ªã ƒë·ªß l·ªõn so v·ªõi chi ph√≠ v√† th·ªùi gian.";
                        } else { 
                            eventResultText = "<strong>KH√îNG N√äN THAM GIA</strong><br>Chi ph√≠ (ti·ªÅn/th·ªùi gian/nƒÉng l∆∞·ª£ng) v∆∞·ª£t qu√° l·ª£i √≠ch.";
                        }
                    } else if (quizMode === 'rich') { // M√¨nh ƒëang s·ªëng d∆∞ d·∫£ (Threshold: 4)
                        if (scoreEvent >= 4) {
                            eventResultText = "<strong>N√äN THAM GIA</strong><br>ƒê√¢y l√† ho·∫°t ƒë·ªông mang l·∫°i gi√° tr·ªã ƒë·ªß l·ªõn so v·ªõi chi ph√≠ v√† th·ªùi gian.";
                        } else { 
                            eventResultText = "<strong>KH√îNG N√äN THAM GIA</strong><br>Chi ph√≠ (ti·ªÅn/th·ªùi gian/nƒÉng l∆∞·ª£ng) v∆∞·ª£t qu√° l·ª£i √≠ch.";
                        }
                    } else if (quizMode === 'strict') { // M√¨nh th·∫≠t s·ª± c·∫ßn ti·∫øt ki·ªám (Threshold: 12)
                        if (scoreEvent >= 12) {
                            eventResultText = "<strong>N√äN THAM GIA</strong><br>ƒê√¢y l√† ho·∫°t ƒë·ªông mang l·∫°i gi√° tr·ªã ƒë·ªß l·ªõn so v·ªõi chi ph√≠ v√† th·ªùi gian.";
                        } else { 
                            eventResultText = "<strong>KH√îNG N√äN THAM GIA</strong><br>Chi ph√≠ (ti·ªÅn/th·ªùi gian/nƒÉng l∆∞·ª£ng) v∆∞·ª£t qu√° l·ª£i √≠ch.";
                        }
                    }
                    showResultModal("K·∫æT LU·∫¨N C·ª¶A CASHCAT", eventResultText);
                    break;

                // --- H·ªéI RESTART (Ch·ªâ c√≤n c√¢u h·ªèi) ---
                case 'ask_restart':
                    pushMessage('cashcat', "B·∫°n c√≥ mu·ªën h·ªèi Cashcat th√™m g√¨ kh√¥ng, meow?", 'question', true);
                    renderOptions([
                        { text: "C√≥", value: 'yes' },
                        { text: "Kh√¥ng", value: 'no' }
                    ], handleAnswer);
                    break;

                // --- K·∫æT TH√öC CU·ªòC TR√í CHUY·ªÜN (Ch·ªâ c√≤n l·ªùi c·∫£m ∆°n) ---
                case 'conclusion':
                    // L·ªùi c·∫£m ∆°n ƒë∆∞·ª£c push khi user tr·∫£ l·ªùi "Kh√¥ng" ·ªü 'ask_restart'
                    pushMessage('cashcat', "Cashcat c·∫£m ∆°n b·∫°n r·∫•t nhi·ªÅu, hi v·ªçng g·ª£i √Ω c·ªßa m√¨nh ƒë√£ gi√∫p ƒë·ª° b·∫°n ph·∫ßn n√†o trong vi·ªác qu·∫£n l√Ω chi ti√™u nh√©, meow~", 'conclusion', false);
                    // X√≥a khu v·ª±c input
                    inputArea.innerHTML = '';
                    break;

                default:
                    pushMessage('cashcat', "ƒê√£ x·∫£y ra l·ªói trong lu·ªìng tr√≤ chuy·ªán. Vui l√≤ng t·∫£i l·∫°i trang ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i. meow~", 'conclusion');
                    break;
            }
        }

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
        document.addEventListener('DOMContentLoaded', () => {
            renderChatbox();
        });
    </script>
</body>
</html>
